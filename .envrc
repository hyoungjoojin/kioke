#!/bin/bash

warn() {
    local MESSAGE="$1"

    echo "[WARNING] $MESSAGE" >&1
}

error() {
    local MESSAGE="$1"

    echo "[ERROR] $MESSAGE" >&2
    exit -1
}

check() {
    local KEY="$1"

    if [ ! -f "$ENV_FILE" ]; then
        error "Could not locate .env file."
    fi

    if ! grep -q "^$KEY=" "$ENV_FILE"; then
        error "Key $KEY does not exist in $ENV_FILE."
        return 0
    fi
}

write() {
    local FILE=$1
    local KEY="$2"
    local VALUE="$3"

    if [ ! -f "$FILE" ]; then
        error "Could not locate file $FILE."
    fi

    if grep -q "^$KEY=" "$FILE"; then
        sed -i "s/^$KEY=.*/$KEY=$VALUE/" "$FILE"
    else
        echo "$KEY=$VALUE" >> "$FILE"
    fi
}

ENV_FILE=.env
if [ ! -f "$ENV_FILE" ]; then
    warn "Could not locate .env file. Creating an empty .env file. Required keys are not set."
    touch $ENV_FILE
fi

JOURNAL_SERVICE_ENV_FILE=./journal-service/.env
if [ ! -f "$JOURNAL_SERVICE_ENV_FILE" ]; then
    touch $JOURNAL_SERVICE_ENV_FILE
fi

export JOURNAL_SERVICE_PORT=31031

check JOURNAL_SERVICE_DATABASE_USERNAME
check JOURNAL_SERVICE_DATABASE_PASSWORD

write $JOURNAL_SERVICE_ENV_FILE JOURNAL_SERVICE_PORT $JOURNAL_SERVICE_PORT
