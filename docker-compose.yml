services:
  user-service:
    container_name: user-service
    restart: unless-stopped
    build:
      context: ./user-service
      dockerfile: Dockerfile
    env_file:
      - ./.env
    environment:
      - POSTGRES_USER=$USER_SERVICE_DATABASE_USER_USERNAME
      - POSTGRES_PASSWORD=$USER_SERVICE_DATABASE_USER_PASSWORD
      - SPRING_DATASOURCE_URL=jdbc:postgresql://user-service-database:5432/$USER_SERVICE_DATABASE_NAME
      - SPRING_DATASOURCE_USERNAME=$USER_SERVICE_DATABASE_USER_USERNAME
      - SPRING_DATASOURCE_PASSWORD=$USER_SERVICE_DATABASE_USER_PASSWORD
      - SPRING_JPA_HIBERNATE_DDL_AUTO=update
      - SECURITY_JWT_KEY=$JWT_TOKEN_SECRET_KEY
      - SECURITY_JWT_EXPIRATION=3600000
      - SERVER_PORT=$USER_SERVICE_PORT
    ports:
      - $USER_SERVICE_PORT:$USER_SERVICE_PORT
    depends_on:
      - user-service-database
    networks:
      - user-service-network

  user-service-database:
    container_name: user-service-database
    restart: unless-stopped
    image: postgres:17
    env_file:
      - ./.env
    environment:
      - POSTGRES_DB=$USER_SERVICE_DATABASE_NAME
      - POSTGRES_USER=$USER_SERVICE_DATABASE_USER_USERNAME
      - POSTGRES_PASSWORD=$USER_SERVICE_DATABASE_USER_PASSWORD
    volumes:
      - user-service-data:/var/lib/postgresql/data
    networks:
      - user-service-network

  journal-service:
    container_name: journal-service
    restart: unless-stopped
    build:
      context: ./journal-service
      dockerfile: Dockerfile
    env_file:
      - ./.env
    environment:
      - SPRING_DATA_MONGODB_HOST=journal-service-database
      - SPRING_DATA_MONGODB_PORT=27017
      - SPRING_DATA_MONGODB_DATABASE=$JOURNAL_SERVICE_DATABASE_NAME
      - SPRING_DATA_MONGODB_USERNAME=$JOURNAL_SERVICE_DATABASE_USER_USERNAME
      - SPRING_DATA_MONGODB_PASSWORD=$JOURNAL_SERVICE_DATABASE_USER_PASSWORD
      - SERVER_PORT=$JOURNAL_SERVICE_PORT
    ports:
      - $JOURNAL_SERVICE_PORT:$JOURNAL_SERVICE_PORT
    depends_on:
      - journal-service-database
    networks:
      - journal-service-network

  journal-service-database:
    container_name: journal-service-database
    restart: unless-stopped
    image: mongo:5.0.2
    env_file:
      - ./.env
    environment:
      - MONGO_INITDB_ROOT_USERNAME=$JOURNAL_SERVICE_DATABASE_ADMIN_USERNAME
      - MONGO_INITDB_ROOT_PASSWORD=$JOURNAL_SERVICE_DATABASE_ADMIN_PASSWORD
      - MONGO_INITDB_DATABASE=$JOURNAL_SERVICE_DATABASE_NAME
    volumes:
      - journal-service-data:/data/db
      - ./journal-service/.db.init.sh:/docker-entrypoint-initdb.d/db.init.sh:ro
    networks:
      - journal-service-network

volumes:
  user-service-data:
  journal-service-data:

networks:
  user-service-network:
    driver: bridge
  journal-service-network:
    driver: bridge
